---
slug: zustand
title: –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Zustand
description: –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Zustand
authors: harryheman
tags: [react.js, reactjs, react, zustand, reverse engineering, state management, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º, –æ–±—Ä–∞—Ç–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞]
---

Hello world!

[Zustand](https://github.com/pmndrs/zustand/tree/main) (—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ "—Ü—É—à—Ç–∞–Ω–¥", —á—Ç–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è —Å –Ω–µ–º–µ—Ü–∫–æ–≥–æ –∫–∞–∫ "—Å–æ—Å—Ç–æ—è–Ω–∏–µ") - —ç—Ç–æ, –Ω–∞ –º–æ–π –≤–∑–≥–ª—è–¥, –æ–¥–∏–Ω –∏–∑ –ª—É—á—à–∏—Ö –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –Ω–∞ [React](https://react.dev/).

–í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —è –Ω–µ–º–Ω–æ–≥–æ —Ä–∞—Å—Å–∫–∞–∂—É –æ —Ç–æ–º, –∫–∞–∫ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç.

–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å –ø—Ä–∏–º–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `zustand` –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è/—Å–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞.

<!--truncate-->

–ö–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞ –ª–µ–∂–∏—Ç [–∑–¥–µ—Å—å](https://github.com/harryheman/blog-posts/tree/master/zustand-reverse-engineering).

–î–µ–º–æ:

<iframe src="https://codesandbox.io/embed/zustand-reverse-engineering-8zdr5m?fontsize=14&hidenavigation=1&theme=dark"
  style={{width: '100%', height: '500px', border: 0,  borderRadius: '4px', overflow: 'hidden'}}
  title="romantic-chandrasekhar-w4zcct"
  allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
  sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
></iframe>

---

_–î–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ —è –±—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å [Yarn](https://yarnpkg.com/)._

–°–æ–∑–¥–∞–µ–º —à–∞–±–ª–æ–Ω React-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é [Vite](https://vitejs.dev/):

```bash
# zustand-test - –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# react-ts - —à–∞–±–ª–æ–Ω –ø—Ä–æ–µ–∫—Ç–∞, –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ React
yarn create vite zustand-test --template react
```

–ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ–∑–¥–∞–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

```bash
cd zustand-test
yarn
yarn dev
```

–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

```bash
yarn add zustand use-sync-external-store react-use
```

- [react-use](https://github.com/streamich/react-use) - –±–æ–ª—å—à–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ö—É–∫–æ–≤;
- [use-sync-external-store](https://www.npmjs.com/package/use-sync-external-store) - –æ–± —ç—Ç–æ–º –º—ã –ø–æ–≥–æ–≤–æ—Ä–∏–º —á—É—Ç—å –ø–æ–∑–∂–µ.

–û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ö—É–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –º–æ–¥–∞–ª–∫–∏ –≤ —Ñ–∞–π–ª–µ `hooks/useModal.js`:

```javascript
import { create } from 'zustand'

const useModal = create((set) => ({
  isOpen: false,
  open: () => set({ isOpen: true }),
  close: () => set({ isOpen: false }),
}))

export default useModal
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–¥–∞–ª–∫–∏ –≤ —Ñ–∞–π–ª–µ `components/Modal.jsx`:

```javascript
import { useEffect, useRef } from 'react'
import { useClickAway } from 'react-use'
import useModal from '../hooks/useModal'

export default function Modal() {
  // —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–¥–∞–ª–∫–∏
  const modal = useModal()
  // —Å—Å—ã–ª–∫–∞ –Ω–∞ –º–æ–¥–∞–ª–∫—É
  const modalRef = useRef(null)
  // —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª–∫–∏
  const modalContentRef = useRef(null)

  useEffect(() => {
    if (!modalRef.current) return

    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ `isOpen`
    // `showModal` –∏ `close` - —ç—Ç–æ –Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º—ã–µ HTML-—ç–ª–µ–º–µ–Ω—Ç–æ–º `dialog`
    if (modal.isOpen) {
      modalRef.current.showModal()
    } else {
      modalRef.current.close()
    }
  }, [modal.isOpen])

  // —Å–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –ø—Ä–∏ –∫–ª–∏–∫–µ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
  useClickAway(modalContentRef, modal.close)

  if (!modal.isOpen) return null

  return (
    <dialog
      style={{
        padding: 0,
      }}
      ref={modalRef}
    >
      <div
        style={{
          padding: '1rem',
          display: 'flex',
          alignItems: 'center',
          gap: '1rem',
        }}
        ref={modalContentRef}
      >
        <div>Modal content</div>
        <button onClick={modal.close}>X</button>
      </div>
    </dialog>
  )
}
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –≤ —Ñ–∞–π–ª–µ `index.css`:

```css
body {
  margin: 0;
}

#root {
  min-height: 100vh;
  display: grid;
  place-content: center;
}

dialog::backdrop {
  background-color: rgba(0, 0, 0, 0.4);
}
```

–ù–∞–∫–æ–Ω–µ—Ü, —Ä–µ–Ω–¥–µ—Ä–∏–º –º–æ–¥–∞–ª–∫—É –≤ —Ñ–∞–π–ª–µ `App.jsx`:

```javascript
import Modal from './components/Modal'
import useModal from './hooks/useModal'

function App() {
  const modal = useModal()

  return (
    <>
      <button onClick={modal.open}>Open modal</button>
      <Modal />
    </>
  )
}

export default App
```

–≠—Ç–æ –±—ã–ª–æ –ª–µ–≥–∫–æ, –Ω–µ –ø—Ä–∞–≤–¥–∞ –ª–∏? –ê –≤—Å–µ –±–ª–∞–≥–æ–¥–∞—Ä—è –º–∞–≥–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏ `create`üòè

---

–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ `zustand` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è [–∑–¥–µ—Å—å](https://github.com/pmndrs/zustand/tree/main/src). –ü–æ—Å–∫–æ–ª—å–∫—É –º—ã –±—É–¥–µ–º —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º—ã–π —ç—Ç–∏–º –ø–∞–∫–µ—Ç–æ–º, –Ω–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç 2 —Ñ–∞–π–ª–∞ - `vanilla.ts` –∏ `react.ts`.

–ö–æ–¥, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π—Å—è –≤ —Ñ–∞–π–ª–µ `vanilla.ts`, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –ø–∞—Ç—Ç–µ—Ä–Ω–∞ "–ò–∑–¥–∞—Ç–µ–ª—å/–ø–æ–¥–ø–∏—Å—á–∏–∫" (publisher/subscriber, pub/sub).

–°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª `zustand/vanilla.js` —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è:

```javascript
const createStoreImpl = (createState) => {
  // —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  let state
  // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  const listeners = new Set()

  // —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
  const setState = (partial, replace) => {
    // —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    const nextState = typeof partial === 'function' ? partial(state) : partial
    // –µ—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
    if (!Object.is(nextState, state)) {
      // –ø—Ä–µ–¥—ã–¥—É—â–µ–µ/—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      const previousState = state
      // –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é `nextState` (–µ—Å–ª–∏ `replace === true` –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ–º `nextState` —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏–º–∏—Ç–∏–≤)
      // –∏–ª–∏ –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞, –æ–±—ä–µ–¥–∏–Ω—è—é—â–µ–≥–æ `state` –∏ `nextState`
      state =
        replace ?? typeof nextState !== 'object'
          ? nextState
          : Object.assign({}, state, nextState)
      // –∑–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      listeners.forEach((listener) => listener(state, previousState))
    }
  }

  // —Ñ—É–Ω–∫—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
  const getState = () => state

  // —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
  // `listener` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `onStoreChange`
  // —Å–º. –∫–æ–¥ —Ö—É–∫–∞ `useSyncExternalStoreWithSelector` - –æ–± —ç—Ç–æ–º —á—É—Ç—å –ø–æ–∑–∂–µ
  const subscribe = (listener) => {
    // –¥–æ–±–∞–≤–ª—è–µ–º/—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    listeners.add(listener)
    // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø–∏—Å–∫–∏
    return () => listeners.delete(listener)
  }

  // —Ñ—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
  const destroy = () => {
    listeners.clear()
  }

  const api = { setState, getState, subscribe, destroy }
  // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  state = createState(setState, getState, api)
  // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ—Ç–æ–¥—ã
  return api
}

// –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è,
// –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ª–∏–±–æ `api`, –ª–∏–±–æ —Ñ—É–Ω–∫—Ü–∏—é `createStoreImpl`
export const createStore = (createState) =>
  createState ? createStoreImpl(createState) : createStoreImpl
```

–î—É–º–∞—é, –∑–¥–µ—Å—å –≤—Å–µ –ø–æ–Ω—è—Ç–Ω–æ. –î–≤–∏–≥–∞–µ–º—Å—è –¥–∞–ª—å—à–µ.

–ö–æ–¥, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π—Å—è –≤ —Ñ–∞–π–ª–µ `react.ts`, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –∏–ª–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–≥–æ pub/sub –≤ React fiber.

–°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª `zustand/react.js` —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è:

```javascript
// `CommonJS`
import useSyncExternalStoreExports from 'use-sync-external-store/shim/with-selector'
import { createStore } from './vanilla.js'

const { useSyncExternalStoreWithSelector } = useSyncExternalStoreExports

export function useStore(api, selector = api.getState, equalityFn) {
  // –ø–æ–ª—É—á–∞–µ–º —á–∞—Å—Ç—å (—Å—Ä–µ–∑) —Å–æ—Å—Ç–æ—è–Ω–∏—è
  const slice = useSyncExternalStoreWithSelector(
    api.subscribe,
    api.getState,
    api.getServerState || api.getState,
    selector,
    equalityFn,
  )
  // –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
  return slice
}

const createImpl = (createState) => {
  // –ø–æ–ª—É—á–∞–µ–º –º–µ—Ç–æ–¥—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–µ–π `createStore`
  const api =
    typeof createState === 'function' ? createStore(createState) : createState

  // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ö—É–∫, –≤—ã–∑—ã–≤–∞—é—â–∏–π —Ö—É–∫ `useStore` —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–π
  // —Ñ—É–Ω–∫—Ü–∏–µ–π-—Å–µ–ª–µ–∫—Ç–æ—Ä–æ–º (`selector`) –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —á–∞—Å—Ç–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏
  // —Ñ—É–Ω–∫—Ü–∏–µ–π —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (`equalityFn`) –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
  const useBoundStore = (selector, equalityFn) =>
    useStore(api, selector, equalityFn)

  // —ç—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å
  // –≤—ã–∑—ã–≤–∞—Ç—å —Ö—É–∫ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ -
  // `useModal.getState()`
  Object.assign(useBoundStore, api)

  return useBoundStore
}

// –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ª–∏–±–æ —Ö—É–∫ `useBoundStore`, –ª–∏–±–æ —Ñ—É–Ω–∫—Ü–∏—é `createImpl`
export const create = (createState) =>
  createState ? createImpl(createState) : createImpl
```

_–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–º–µ–Ω–∏—Ç—å `import { create } from 'zustand'` –Ω–∞ `import { create } from '../zustand/react'` –≤ `useModal.js` –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å._

–í–æ—Ç –≥–¥–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –º–∞–≥–∏—èüòâ

–•—É–∫ [useSyncExternalStoreWithSelector](https://github.com/facebook/react/blob/main/packages/use-sync-external-store/src/useSyncExternalStoreWithSelector.js) - —ç—Ç–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –≤–µ—Ä—Å–∏—è —Ö—É–∫–∞ [useSyncExternalStore](https://react.dev/reference/react/useSyncExternalStore) (`useSyncExternalStore` –∏ –µ–≥–æ —Ä–∞–∑–Ω–æ–≤–∏–¥–Ω–æ—Å—Ç–∏ –ø–æ—á–µ–º—É-—Ç–æ –ª–µ–∂–∞—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–∞–∫–µ—Ç–µ). –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –Ω–∏–º–∏ —Å–æ—Å—Ç–æ–∏—Ç –≤ —Ç–æ–º, —á—Ç–æ `useSyncExternalStoreWithSelector` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç 2 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:

- `selector` - —Ñ—É–Ω–∫—Ü–∏—è-—Å–µ–ª–µ–∫—Ç–æ—Ä –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —á–∞—Å—Ç–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ);
- `equalityFn` - —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∏ –Ω–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏–π, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞.

–í—ã–∑–æ–≤ `useModal` —Å —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–º:

```javascript
const isModalOpen = useModal((state) => state.isOpen)
```

–í—ã–∑–æ–≤ `useModal` —Å —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–º –∏ —Ñ—É–Ω–∫—Ü–∏–µ–π —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:

```javascript
import { shallow } from 'zustand/shallow'

const { open, close } = useModal(({ open, close }) => ({ open, close }), shallow)
```

–î–ª—è —á–µ–≥–æ –Ω—É–∂–µ–Ω —Ö—É–∫ `useSyncExternalStore`?

–ö–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã React —á–∏—Ç–∞—é—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ–ø–æ–≤, —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –û–¥–Ω–∞–∫–æ –∏–Ω–æ–≥–¥–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å –º–µ–Ω—è—é—â–∏–µ—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞, –Ω–∞—Ö–æ–¥—è—â–µ–≥–æ—Å—è –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ React. –¢–∞–∫–∏–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –º–æ–∂–µ—Ç –±—ã—Ç—å:

- —Å—Ç–æ—Ä–æ–Ω–Ω—è—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (—Ç–∞–∫–∞—è –∫–∞–∫ `zustand`), –∫–æ—Ç–æ—Ä–∞—è —Ö—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ React;
- –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π API, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π –º—É—Ç–∏—Ä—É–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

`useSyncExternalStore` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç 2 –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∏ 1 –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä:

- `subscribe` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä) - —Ñ—É–Ω–∫—Ü–∏—è, –ø—Ä–∏–Ω–∏–º–∞—é—â–∞—è –ø–∞—Ä–∞–º–µ—Ç—Ä `callback` –∏ –≤—ã–ø–æ–ª–Ω—è—é—â–∞—è –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. `callback` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞. `subscribe` –¥–æ–ª–∂–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø–∏—Å–∫–∏ –æ—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞;
- `getSnapshot` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä) - —Ñ—É–Ω–∫—Ü–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è —Å–Ω–∏–º–æ–∫ (snapshot) —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞, –ø–æ—Ç—Ä–µ–±–ª—è–µ–º–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º. –ï—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã `getSnapshot` –¥–æ–ª–∂–Ω—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è. –ï—Å–ª–∏ –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ, React –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞;
- `getServerSnapshot` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä) - —Ñ—É–Ω–∫—Ü–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è –Ω–∞—á–∞–ª—å–Ω—ã–π —Å–Ω–∏–º–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞. –û–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ –µ–≥–æ –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ.

`useSyncExternalStore` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–Ω–∏–º–æ–∫ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ª–æ–≥–∏–∫–µ (—Ü–∏–∫–ª–µ) —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ React.

–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–º —Ö—É–∫–µ –º–æ–∂–Ω–æ –ø–æ—á–∏—Ç–∞—Ç—å –≤ [—ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ](https://habr.com/ru/companies/timeweb/articles/720136/).

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, `useSyncExternalStore` –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è, –Ω–∞—Ö–æ–¥—è—â–µ–≥–æ—Å—è –≤–æ –≤–Ω–µ—à–Ω–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, —Å–ø–æ—Å–æ–±–æ–º, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–º —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ React. –¶–∏–∫–ª —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞, –≤ —á–∏—Å–ª–µ –ø—Ä–æ—á–µ–≥–æ, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç –≤—ã–∑–æ–≤ _–æ–¥–∏–Ω–∞–∫–æ–≤–æ–π –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ö—É–∫–æ–≤_, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º. –û–¥–∏–Ω–∞–∫–æ–≤–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–∑–æ–≤–∞ (–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ) —Ö—É–∫–æ–≤ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ö—É–∫–æ–≤. –≠—Ç–æ –ª–æ–≥–∏—á–Ω–æ: –≤—ã–∑–æ–≤ —Ö—É–∫–æ–≤ –≤ –¥—Ä—É–≥–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–ª–∏ –≤ –º–µ–Ω—å—à–µ–º/–±–æ–ª—å—à–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞.

_`useSyncExternalStore` –¥–µ–ª–∞–µ—Ç –Ω–∞—à pub/sub (–≤–Ω–µ—à–Ω–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ) —á–∞—Å—Ç—å—é —Å–∏—Å—Ç–µ–º—ã —Ö—É–∫–æ–≤, —Ñ–æ—Ä–º–∏—Ä—É—é—â–µ–π –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞._

–ö–æ–¥ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ —Ö—É–∫–∞ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ [–∑–¥–µ—Å—å](https://github.com/facebook/react/blob/main/packages/react-reconciler/src/ReactFiberHooks.js#L1464) (—Ñ—É–Ω–∫—Ü–∏–∏ `mountSyncExternalStore` –∏ —Å–ª–µ–¥—É—é—â–∞—è –∑–∞ –Ω–µ–π `updateSyncExternalStore`).

"–ì–æ–ª–∞—è" `mountSyncExternalStore` –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

```javascript
function mountSyncExternalStore(
  subscribe,
  getSnapshot,
  getServerSnapshot,
) {
  // –≤–æ–ª–æ–∫–Ω–æ
  const fiber = currentlyRenderingFiber
  // —Ç–µ–∫—É—â–∏–π/–≤—ã–ø–æ–ª–Ω—è–µ–º—ã–π —Ö—É–∫
  const hook = mountWorkInProgressHook()

  // —Å–ª–µ–¥—É—é—â–∏–π —Å–Ω–∏–º–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  let nextSnapshot
  const isHydrating = getIsHydrating()
  if (isHydrating) {
    nextSnapshot = getServerSnapshot()
  } else {
    nextSnapshot = getSnapshot()
  }

  // —á–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–Ω–∏–º–æ–∫ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –Ω–∞ –∫–∞–∂–¥–æ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ
  // —ç—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç –æ–±—ã—á–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ React –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –±–ª–∞–≥–æ–¥–∞—Ä—è —Ç–æ–º—É,
  // —á—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –≤—Å–µ–≥–¥–∞ —è–≤–ª—è—é—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏
  hook.memoizedState = nextSnapshot
  const inst = {
    value: nextSnapshot,
    getSnapshot,
  }
  hook.queue = inst

  // –∑–¥–µ—Å—å –ø–ª–∞–Ω–∏—Ä—É—é—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏
  // –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º—É—Ç–∏—Ä—É–µ–º—ã—Ö –ø–æ–ª–µ–π —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ (`inst`),
  // –∫–æ—Ç–æ—Ä—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ `subscribe`, `getSnapshot` –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è
  // —ç—Ç–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞—Å –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç

  return nextSnapshot
}
```

–û—Ç–ª–∏—á–∏—è `updateSyncExternalStore` –æ—Ç `mountSyncExternalStore` —Å–≤–æ–¥—è—Ç—Å—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É:

```javascript
// –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–Ω–∏–º–æ–∫
const prevSnapshot = (currentHook || hook).memoizedState;
// –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ?
const snapshotChanged = !is(prevSnapshot, nextSnapshot);
// –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
if (snapshotChanged) {
  hook.memoizedState = nextSnapshot;
  markWorkInProgressReceivedUpdate();
}
const inst = hook.queue;
```

–í –∫–∞—á–µ—Å—Ç–≤–µ –±–æ–Ω—É—Å–∞ –ª–æ–≤–∏—Ç–µ —Å–ª–µ–≥–∫–∞ –≤–∏–¥–æ–∏–∑–º–µ–Ω–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é `shallow`, –ø–æ–∑–≤–æ–ª—è—é—â—É—é –≥–ª—É–±–æ–∫–æ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä–æ–π –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–π:

```javascript
function equal<T>(objA: T, objB: T): boolean {
  if (Object.is(objA, objB)) {
    return true
  }

  if (
    typeof objA !== 'object' ||
    objA === null ||
    typeof objB !== 'object' ||
    objB === null
  ) {
    return false
  }

  if (
    (Array.isArray(objA) && !Array.isArray(objB)) ||
    (Array.isArray(objB) && !Array.isArray(objA))
  ) {
    return false
  }

  if (objA instanceof Map && objB instanceof Map) {
    if (objA.size !== objB.size) return false

    for (const [key, value] of objA) {
      if (!Object.is(value, objB.get(key))) {
        return false
      }
    }
    return true
  }

  if (objA instanceof Set && objB instanceof Set) {
    if (objA.size !== objB.size) return false

    for (const value of objA) {
      if (!objB.has(value)) {
        return false
      }
    }
    return true
  }

  if (objA instanceof Date && objB instanceof Date) {
    return Object.is(objA.getTime(), objA.getTime())
  }

  const keysA = Object.keys(objA)
  if (keysA.length !== Object.keys(objB).length) {
    return false
  }

  return keysA.every((key) => equal(objA[key as keyof T], objB[key as keyof T]))
}
```

–ù–∞–¥–µ—é—Å—å, –≤—ã —É–∑–Ω–∞–ª–∏ —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ –∏ –Ω–µ –∑—Ä—è –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ –≤—Ä–µ–º—è.

The end.